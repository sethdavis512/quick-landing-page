---
interface Props {
  campaign: string;
  apiUrl: string;
}

const { campaign, apiUrl } = Astro.props;
---

<form class="signup-form w-full max-w-md" data-api-url={apiUrl}>
  <input type="hidden" name="campaign" value={campaign} />
  <div class="flex flex-col gap-3">
    <div>
      <input
        type="text"
        name="name"
        placeholder="Name (optional)"
        class="signup-form__input w-full px-4 py-3 border border-[var(--color-border,#d1d5db)] rounded-md text-base outline-none transition-colors duration-200 focus:border-[var(--color-accent)] bg-transparent text-inherit"
      />
    </div>
    <div>
      <input
        type="email"
        name="email"
        placeholder="Email address"
        class="signup-form__input w-full px-4 py-3 border border-[var(--color-border,#d1d5db)] rounded-md text-base outline-none transition-colors duration-200 focus:border-[var(--color-accent)] bg-transparent text-inherit"
      />
      <p class="signup-form__field-error mt-1 text-sm text-red-500 hidden" data-field="email"></p>
    </div>
    <button
      type="submit"
      class="signup-form__button px-6 py-3 bg-[var(--color-accent)] text-white border-none rounded-md font-semibold text-base cursor-pointer transition-opacity duration-200 hover:opacity-85 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Sign Up
    </button>
  </div>
  <p class="signup-form__message mt-3 text-sm min-h-5" aria-live="polite"></p>
</form>

<script>
  import { signupSchema } from "@quick-landing-page/shared-config";

  document.querySelectorAll<HTMLFormElement>(".signup-form").forEach(function (form) {
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const apiUrl = form.dataset.apiUrl;
      const formData = new FormData(form);
      const message = form.querySelector<HTMLParagraphElement>(".signup-form__message")!;
      const button = form.querySelector<HTMLButtonElement>(".signup-form__button")!;

      // Clear previous errors
      button.disabled = true;
      message.textContent = "";
      message.className = "signup-form__message mt-3 text-sm min-h-5";
      form.querySelectorAll<HTMLParagraphElement>(".signup-form__field-error").forEach(function (el) {
        el.textContent = "";
        el.classList.add("hidden");
      });

      const raw = {
        email: (formData.get("email") as string) || "",
        campaign: formData.get("campaign") as string,
        name: (formData.get("name") as string) || undefined,
      };

      const result = signupSchema.safeParse(raw);

      if (!result.success) {
        const fieldErrors = result.error.flatten().fieldErrors;
        for (const [field, errors] of Object.entries(fieldErrors)) {
          const el = form.querySelector<HTMLParagraphElement>(`.signup-form__field-error[data-field="${field}"]`);
          if (el && errors && errors.length > 0) {
            el.textContent = errors[0];
            el.classList.remove("hidden");
          }
        }
        button.disabled = false;
        return;
      }

      try {
        const res = await fetch(`${apiUrl}/signups`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(result.data),
        });

        const data = await res.json();

        if (res.ok) {
          message.textContent = "You're signed up!";
          message.classList.add("text-green-600");
          form.reset();
        } else {
          message.textContent = data.error || "Something went wrong.";
          message.classList.add("text-red-600");
        }
      } catch {
        message.textContent = "Network error. Please try again.";
        message.classList.add("text-red-600");
      } finally {
        button.disabled = false;
      }
    });
  });
</script>
