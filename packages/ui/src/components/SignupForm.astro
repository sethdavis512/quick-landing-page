---
interface Props {
  campaign: string;
  apiUrl: string;
}

const { campaign, apiUrl } = Astro.props;
---

<form class="signup-form w-full max-w-md" data-api-url={apiUrl}>
  <input type="hidden" name="campaign" value={campaign} />
  <div class="flex flex-col gap-3">
    <input
      type="text"
      name="name"
      placeholder="Name (optional)"
      class="signup-form__input px-4 py-3 border border-[var(--color-border,#d1d5db)] rounded-md text-base outline-none transition-colors duration-200 focus:border-[var(--color-accent)] bg-transparent text-inherit"
    />
    <input
      type="email"
      name="email"
      placeholder="Email address"
      required
      class="signup-form__input px-4 py-3 border border-[var(--color-border,#d1d5db)] rounded-md text-base outline-none transition-colors duration-200 focus:border-[var(--color-accent)] bg-transparent text-inherit"
    />
    <button
      type="submit"
      class="signup-form__button px-6 py-3 bg-[var(--color-accent)] text-white border-none rounded-md font-semibold text-base cursor-pointer transition-opacity duration-200 hover:opacity-85 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Sign Up
    </button>
  </div>
  <p class="signup-form__message mt-3 text-sm min-h-5" aria-live="polite"></p>
</form>

<script>
  document.querySelectorAll<HTMLFormElement>(".signup-form").forEach(function (form) {
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const apiUrl = form.dataset.apiUrl;
      const formData = new FormData(form);
      const message = form.querySelector<HTMLParagraphElement>(".signup-form__message")!;
      const button = form.querySelector<HTMLButtonElement>(".signup-form__button")!;

      button.disabled = true;
      message.textContent = "";
      message.className = "signup-form__message mt-3 text-sm min-h-5";

      try {
        const res = await fetch(`${apiUrl}/signups`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: formData.get("email"),
            campaign: formData.get("campaign"),
            name: formData.get("name") || undefined,
          }),
        });

        const data = await res.json();

        if (res.ok) {
          message.textContent = "You're signed up!";
          message.classList.add("text-green-600");
          form.reset();
        } else {
          message.textContent = data.error || "Something went wrong.";
          message.classList.add("text-red-600");
        }
      } catch {
        message.textContent = "Network error. Please try again.";
        message.classList.add("text-red-600");
      } finally {
        button.disabled = false;
      }
    });
  });
</script>
